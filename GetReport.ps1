

start-transcript MonthlyKB.log
$periods = 'Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'

$dt=Get-Date
if ($dt.Day -lt 10){
	if ($dt.Month -eq 1){
		$monthOfInterest = $dt.AddYears(-1).Year.ToString()+"-Dec"
	}
}
else
	{
		$monthOfInterest = $dt.Year.ToString()+"-"+$periods[$dt.Month-1]	
	}
write-Host "Period : $monthOfInterest "
#Get-MsrcCvrfDocument -ID $monthOfInterest -Verbose | Get-MsrcSecurityBulletinHtml -Verbose | Out-File .\MSRCAprilSecurityUpdates.html

try{
	$document = Get-MsrcCvrfDocument -ID $monthOfInterest -Verbose
	
	$i = 0
	$outarr = @()
	$wServ = "Windows Server 201"
	$products = @()
	foreach($doc in $document){
		foreach( $Itm in $doc.ProductTree.FullProductName){
			if ($Itm.Value.Contains($wServ)){
				if ($Itm.Value.Substring(0,18) -eq "Windows Server 201"){
					$prodItem = "" | Select  ID, Title
					$prodItem.ID = $Itm.ProductID
					$prodItem.Title = $Itm.Value
					$products += $prodItem
				}
			}
		
			#$outarr += $doc
			#$i++
		}
		foreach($xItm in $doc.Vulnerability){
			$currentCVETitle = $xItm.Title.Value
			$currentCVE = $xItm.CVE
			$CVEFound = $false
			foreach($vItm in $xItm.ProductStatuses){
				
				foreach($pItm in $vItm.ProductID){
					foreach($wProd in $products){
						if ($wProd.ID -eq $pItm){
						 #write-Host "$($wProd.Title) : $currentCVE"
						 $CVEFound = $true
						 break
						}
					}
					if($CVEFound){
						break
					} 				
				}
				if($CVEFound){
					break
				}
			}
			if($CVEFound){
				write-Host
				write-Host "$currentCVE " -f Cyan
				write-Host "$currentCVETitle " -f Cyan
				foreach($rItm in $xItm.Remediations){
					if ($rItm.Type -eq 5){
						$kbFound = $false
						foreach($fItm in $rItm.ProductID){
							foreach($wProd in $products){
								if ($wProd.ID -eq $fItm){
									write-Host "`t$($wProd.Title)" -f Green
									$kbFound = $true
								} 
							}
						}
						if ($kbFound){
							write-Host $("`t$($rItm.URL)") -f Yellow
							write-Host
						}
					}
				}
				foreach($tItm in $xItm.Threats){
					$threadFound = $false
					if ($tItm.Type -eq 3){
						foreach($wProd in $products){
							if ($wProd.ID -eq $tItm.ProductID){
								write-Host "`t$($tItm.Description.Value)" -f Magenta	
								$threadFound = $true
								break
							}								
						}
						if ($threadFound){
							break;
						}						
						
					}
				}	
				
			}
		}
	}
	$outfile = ".\"+ $monthOfInterest+".json"
	#$menuDumpDst = get-content $outfile -encoding default | ConvertFrom-Json
	#$document | ConvertTo-Json -Depth 100 | out-file $outfile -Encoding Default
		
	#$document | Get-MsrcSecurityBulletinHtml -Verbose | Out-File .\MSRC-May-SecurityUpdates.html
	#$outarr | Get-MsrcSecurityBulletinHtml -Verbose | Out-File .\MSRC-2022-May-SecurityUpdates.html
	#Write-Host "Count: $i"
	#$products
}
catch {
  Write-Host "An error occurred:"
  $errX = $_.Exception.Message 
  if ($errX.Contains("does not belong to the set")){
	  Write-Host -f Yellow "Wrong Period : $monthOfInterest"
  }
  write-Host
  Write-Host $_.Exception.Message -f Red
  
}
stop-transcript
